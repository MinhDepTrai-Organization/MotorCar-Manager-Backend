---
deployment:
  tasks:
    # 1ï¸âƒ£ Äáº·t biáº¿n mÃ´i trÆ°á»ng
    - export DEPLOYPATH=/home/xnzbgatp/backend-nestjs
    - export NODEBIN=/home/xnzbgatp/nodevenv/backend-nestjs/20/bin

    # 2ï¸âƒ£ KÃ­ch hoáº¡t mÃ´i trÆ°á»ng Node.js
    - /bin/echo "ğŸŒ± Activating Node.js environment..."
    - source /home/xnzbgatp/nodevenv/backend-nestjs/20/bin/activate

    # 3ï¸âƒ£ Di chuyá»ƒn Ä‘áº¿n thÆ° má»¥c project
    - cd $DEPLOYPATH

    # 4ï¸âƒ£ Pull code má»›i nháº¥t tá»« GitHub
    - /bin/echo "ğŸ”„ Pulling latest code from GitHub..."
    - /bin/git -C $DEPLOYPATH pull origin main

    # 5ï¸âƒ£ CÃ i dependencies
    - /bin/echo "ğŸ“¦ Installing dependencies..."
    - $NODEBIN/npm install --omit=dev

    # 6ï¸âƒ£ Build NestJS project
    - /bin/echo "ğŸ—ï¸ Building NestJS project..."
    - $NODEBIN/npm run build

    # 7ï¸âƒ£ Restart hoáº·c khá»Ÿi Ä‘á»™ng báº±ng PM2
    - /bin/echo "ğŸš€ Restarting NestJS app with PM2..."
    - $NODEBIN/pm2 reload nest-app || $NODEBIN/pm2 start $DEPLOYPATH/dist/main.js --name nest-app

    # 8ï¸âƒ£ HoÃ n táº¥t
    - /bin/echo "âœ… Deployment completed successfully!"
